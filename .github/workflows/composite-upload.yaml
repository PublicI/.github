name: publici-share-upload
on:
  workflow_call:
    inputs:
        acl_policy:
          required: true
          type: string
        upload_directory:
          required: false
          type: string
          default: ""
env:
  gcp_identity_provider: projects/219138289271/locations/global/workloadIdentityPools/publici-share-github/providers/publici-share-github
  gcp_service_account: gh-actions@publici-cluster.iam.gserviceaccount.com
  upload_destination: publici-share/github/${{ github.event.repository.name }}
  bucket_name: publici-share
  upload_prefix: github
  acl_path: acl.yaml
  remote_acl_path: publici-share/.acl
jobs:
  upload:
    if: "!contains(github.event.repository.name, '__')"
    runs-on: ubuntu-20.04
    permissions:
      contents: read
      id-token: write
    steps:
    - id: gh-checkout
      uses: actions/checkout@v2
    - id: gcp-authenticate
      uses: google-github-actions/auth@v0
      with:
        workload_identity_provider: ${{ env.gcp_identity_provider }}
        service_account: ${{ env.gcp_service_account }}
    - id: create-gcloudignore
      shell: bash
      run: |
        echo ".git" >> ${{ github.workspace }}/.gcloudignore
        echo "gha-creds-*.json" >> ${{ github.workspace }}/.gcloudignore
        echo ".github" >> ${{ github.workspace }}/.gcloudignore
    - id: save-acl
      shell: bash
      run: |
        printf '%s\n' "${{ inputs.acl_policy }}" > ${{ github.workspace }}/${{ env.acl_path }}
        rm -rf /tmp/gh-acl-dir
        mkdir /tmp/gh-acl-dir
        cp ${{ github.workspace }}/${{ env.acl_path }} /tmp/gh-acl-dir/${{ env.upload_prefix }}__${{ github.event.repository.name }}.yaml
    - id: gcp-upload-contents
      uses: google-github-actions/upload-cloud-storage@v0.10.2
      with:
        path: ${{ github.workspace }}/${{ inputs.upload_directory }}
        destination: ${{ env.upload_destination }}
        parent: false
    - id: gcp-upload-acl
      uses: google-github-actions/upload-cloud-storage@v0.10.2
      with:
        path: /tmp/gh-acl-dir/
        destination: ${{ env.remote_acl_path }}
        parent: false
        gzip: false
        headers: |-
          content-type: text/yaml